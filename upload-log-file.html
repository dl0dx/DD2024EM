<!DOCTYPE html>
<html lang="en-US"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Upload a Log File</title>
    <style>
      div {
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div>
      <form>
	<label for="file">Choose log file to upload</label>
	<input type="file" id="inputLogFile" name="file" multiple="">
      </form>
      <p>
	Supported File Formats: ADIF, ADX, JSON, Cabrillo.
      </p>
    </div>

    <div hidden="hidden" id="fileInfo">
      File Name: <div id="fileName"></div>
      File Size: <div id="fileSize"></div>
      <p>Log File Format</p>
      <input type="radio" name="logFileFormat" value="ADI" id="inADI">
      <label for="inADI">ADI</label>
      <input type="radio" name="logFileFormat" value="ADX" id="inADX">
      <label for="inADX">ADX</label>
      <input type="radio" name="logFileFormat" value="JSON" id="inJSON">
      <label for="inJSON">JSON</label>
      <input type="radio" name="logFileFormat" value="Cabrillo" id="inCabrillo">
      <label for="inCabrillo">Cabrillo</label>
      <p>
      <button id="check" type="button" name="checkLogs">Check Logs</button>
      </p>
    </div>

    <div hidden="hidden" id="logInfo">
      <p>Logfile Parser:</p>
      <div id="logLength"></div>
      <div id="logLines"></div>
      <button id="upload" type="button" name="uploadLogs">Upload Logs</button>
    </div>

    <div hidden="hidden" id="uploadInfo">
    </div>

    <script>
      // Initialize the event handler checkLogsEvent to an function that just returns.
      var checkLogsEvent = function (event) { };
      var uploadLogsEvent = function (event) { };
      document.getElementById('inputLogFile').addEventListener('change', selectFile);
      document.getElementById('check').addEventListener(
	  "click",
	  function (event) { checkLogsEvent (event); }
      );
      document.getElementById('upload').addEventListener(
	  'click',
	  function (event) { uploadLogsEvent(event); }
      );

      function selectFile (event) {
	  var file = event.target.files[0];
	  hide('logInfo');
	  document.getElementById('fileName').innerHTML = file.name;
	  document.getElementById('fileSize').innerHTML = file.size;
	  setFileType(file.name.split('.').pop());
	  unHide('fileInfo');
          reader = new FileReader();
	  reader.readAsArrayBuffer(file);
	  reader.onload = function() {
	      console.log(reader.result);
	      var uploadData = {
		  "arrayBuffer" : reader.result,
		  "file_name" : file.name,
//		  "file_size" : file.size,
	      };
              checkLogsEvent = function (event) { checkLogs(uploadData); };
          };
	  reader.onerror = function() {
	      console.log(reader.error);
	  };
      };

      function callAdifmt(format, arrayBuffer) {
	  const queryParams = { in: format, out: 'JSON' };
	  const queryString = new URLSearchParams(queryParams).toString();
	  const apiUrl = 'https://dx.darc-r01.de/adif-multitool';
	  const fullUrl = `${apiUrl}?${queryString}`;
	  const fetchOptions = {
	      method: 'post',
	      body: arrayBuffer
	  };
	  return (
	      fetch(fullUrl, fetchOptions)
		  .then(response => {
		      if (!response.ok) { throw new Error('Network response was not OK'); }
		      return response.json();
		  })
	  );
      };

      function checkLogs(uploadData) {
	  hide('fileInfo');
          callAdifmt(
	      document.querySelector('input[type=radio][name=logFileFormat]:checked').value,
	      uploadData.arrayBuffer
	  )
	      .then(data => {
                  document.getElementById('logLength').innerHTML = `
                       <p>Number of log entries: ${data.RECORDS.length}</p>
                  `;
                  document.getElementById('logLines').innerHTML = `
                       <p>First log entry: ${prettyLog(data.RECORDS[0])}</p>
                       <p>Last  log entry: ${prettyLog(data.RECORDS.slice(-1)[0])}</p>
                   `;
		  uploadData["json_logs"] = data;
                  uploadLogsEvent = function (event) { uploadLogs(uploadData); };
		  unHide('logInfo');
	      })
      };

      function uploadLogs(uploadData) {
	  hide('logInfo');
// TODO: storing the original file together with the json decoding in postgrest is tricky
// need to do base64 encode to put it in json and decode it on receiving !
//	  var enc = new TextDecoder("utf-8");
//	  uploadData["file_content"] = enc.decode(uploadData["arrayBuffer"]);
	  delete uploadData.arrayBuffer;
	  const fetchOptions = {
	      method: 'post',
	      headers: new Headers({
		    'content-type': 'application/json'
		  , 'Authorization': 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3MTczNjg3MDksInJvbGUiOiJoYW1sb2d1cGxvYWQiLCJ1c2VyIjoidGVzdHVzZXIifQ.A7GhnH7IU0iMNq6upJClUX3CXgWEJEfciSQ_w0-aNxw'
	          }),
	      body: JSON.stringify(uploadData)
	  };
	  fetch ('https://dx.darc-r01.de/pgrest/rpc/upload_logdata', fetchOptions)
	      .then(response => {
		  if (!response.ok) { throw new Error('Log Upload Failed !'); }
		  return response.json();
	      })
      };

      function prettyLog(l) { return JSON.stringify(l, null, 2); };
      function hide (e) { document.getElementById(e).setAttribute("hidden","hidden"); };
      function unHide (e) { document.getElementById(e).removeAttribute("hidden"); };

      function setFileType (suf) {
        const m = {
	  adi: 'inADI',
	  adif: 'inADI',	      
	  adx: 'inADX',
	  json: 'inJSON',
	  jsn:  'inJSON',	      
	  cabrillo: 'inCabrillo',
	  log: 'inCabrillo'
	};
	if (suf in m) {document.getElementById(m[suf]).checked = true; };
      };
    </script>
</body></html>
